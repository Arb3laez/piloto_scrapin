var m=Object.defineProperty;var p=(i,e,o)=>e in i?m(i,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[e]=o;var l=(i,e,o)=>p(i,typeof e!="symbol"?e+"":e,o);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&t(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();class f{constructor(){l(this,"mediaRecorder",null);l(this,"audioChunks",[]);l(this,"stream",null);l(this,"isRecording",!1);console.log("VoiceRecorder instanciado")}async start(e){var o;try{if(console.log("[START] Solicitando acceso al micrófono..."),!((o=navigator.mediaDevices)!=null&&o.getUserMedia))throw new Error("Tu navegador no soporta getUserMedia");return this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),console.log("[START] Acceso al micrófono concedido"),console.log("[START] Audio tracks:",this.stream.getAudioTracks().length),this.mediaRecorder=new MediaRecorder(this.stream),console.log("[START] MediaRecorder creado"),console.log("[START] MIME type:",this.mediaRecorder.mimeType),this.mediaRecorder.ondataavailable=t=>{var n;if(console.log("[EVENT] ondataavailable - size:",t.data.size),((n=t.data)==null?void 0:n.size)>0){this.audioChunks.push(t.data);try{e(t.data),console.log("[CALLBACK] Chunk enviado correctamente")}catch(r){console.error("[CALLBACK] Error en callback:",r)}}},this.mediaRecorder.onstart=()=>{console.log("[EVENT] MediaRecorder iniciado")},this.mediaRecorder.onstop=()=>{console.log("[EVENT] MediaRecorder detenido")},this.mediaRecorder.onerror=t=>{console.error("[EVENT] Error en MediaRecorder:",t)},this.mediaRecorder.start(1e3),this.isRecording=!0,console.log("[START] Grabación iniciada - Estado:",this.mediaRecorder.state),!0}catch(t){return console.error("[START] Error al iniciar grabación:",t),this.handleRecordingError(t),!1}}stop(){console.log("[STOP] Deteniendo grabación..."),this.mediaRecorder&&this.isRecording?(console.log("[STOP] Estado antes de stop:",this.mediaRecorder.state),this.mediaRecorder.stop(),this.stream&&this.stream.getTracks().forEach(e=>{e.stop(),console.log("[STOP] Track detenido:",e.kind)}),this.isRecording=!1,console.log("[STOP] Grabación detenida completamente")):console.warn("[STOP] No hay grabación activa")}reset(){console.log("[RESET] Reiniciando buffer de audio"),this.audioChunks=[]}isActive(){return this.isRecording}handleRecordingError(e){const t={NotAllowedError:"Permiso denegado. Permite el acceso al micrófono.",NotFoundError:"No se encontró ningún micrófono.",NotReadableError:"El micrófono está siendo usado por otra aplicación."}[e.name]||`Error: ${e.message}`;alert(t)}}async function E(){console.log("========================================"),console.log("INICIANDO TEST DE MICRÓFONO"),console.log("========================================");try{const i=await navigator.mediaDevices.getUserMedia({audio:!0});console.log("Acceso concedido");const e=i.getAudioTracks()[0];console.log("Track settings:",e.getSettings());const o=new MediaRecorder(i);let t=0,n=0;o.ondataavailable=r=>{t++,n+=r.data.size,console.log(`CHUNK #${t}: ${r.data.size} bytes`)},o.onstart=()=>{console.log("¡GRABACIÓN INICIADA! Habla durante 5 segundos...")},o.start(1e3),setTimeout(()=>{o.stop(),i.getTracks().forEach(r=>r.stop()),console.log("========================================"),console.log("RESULTADO:"),console.log(`Total chunks: ${t}`),console.log(`Total bytes: ${n}`),t===0?console.error("FALLO: No se recibieron chunks"):n<1e3?console.warn("ADVERTENCIA: Muy pocos datos"):console.log("ÉXITO: Micrófono funcionando")},5e3)}catch(i){console.error("ERROR EN TEST:",i)}}async function b(){console.log("Verificando dispositivos...");try{const e=(await navigator.mediaDevices.enumerateDevices()).filter(o=>o.kind==="audioinput");console.log("Micrófonos detectados:",e.length),e.forEach((o,t)=>{console.log(`  ${t+1}. ${o.label||"Micrófono sin nombre"}`)}),e.length===0&&console.error("NO SE DETECTARON MICRÓFONOS")}catch(i){console.error("Error verificando dispositivos:",i)}}class v{constructor(){l(this,"ws",null);l(this,"recorder");l(this,"isConnected",!1);this.recorder=new f,console.log("VoiceWebSocket instanciado")}connect(){return new Promise((e,o)=>{console.log("Conectando a WebSocket...");const n=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.hostname}:8000/ws/voice-stream`;this.ws=new WebSocket(n),this.ws.onopen=()=>{console.log("WebSocket conectado"),this.isConnected=!0,this.updateConnectionStatus(!0),e()},this.ws.onmessage=r=>{const s=JSON.parse(r.data);this.handleMessage(s)},this.ws.onerror=r=>{console.error("Error WebSocket:",r),this.updateConnectionStatus(!1),o(r)},this.ws.onclose=()=>{console.log("WebSocket desconectado"),this.isConnected=!1,this.updateConnectionStatus(!1)}})}async startVoiceInput(){try{if(console.log("Iniciando captura de voz..."),this.isConnected||await this.connect(),this.sendFormStructure(),await this.recorder.start(o=>{this.sendAudioChunk(o)}))return console.log("Captura de voz iniciada correctamente"),!0;throw new Error("No se pudo iniciar la grabación")}catch(e){return console.error("Error al iniciar voz:",e),alert(`Error al iniciar el dictado: ${e.message}`),!1}}stopVoiceInput(){console.log("Deteniendo captura de voz..."),this.recorder.stop(),this.ws&&this.isConnected&&(this.ws.send(JSON.stringify({type:"end_stream"})),console.log("Señal de fin enviada al servidor"))}sendFormStructure(){var t;const e=this.extractFormStructure();console.log("[DEBUG] Estructura extraída:",e),console.log("[DEBUG] fields count:",e.fields.length);const o={type:"form_structure",data:e};(t=this.ws)==null||t.send(JSON.stringify(o)),console.log("Estructura del formulario enviada")}extractFormStructure(){const e=document.getElementById("dilatacionForm");if(!e)return console.error("Formulario no encontrado"),{form_id:"dilatacionForm",fields:[]};const o=[],t=new Set;return e.querySelectorAll("input, select, textarea").forEach(r=>{var d;if(!r.name&&!r.id)return;if(r instanceof HTMLInputElement&&r.type==="radio"){if(t.has(r.name))return;t.add(r.name)}const s=this.getFieldLabel(r),c={name:r.name||r.id,id:r.id||void 0,label:s,type:r instanceof HTMLInputElement?r.type:r.tagName.toLowerCase(),required:r.required,selector:r.name?`[name="${r.name}"]`:`#${r.id}`};if(r instanceof HTMLSelectElement&&(c.options=Array.from(r.options).filter(a=>a.value).map(a=>{var u;return{value:a.value,text:((u=a.textContent)==null?void 0:u.trim())||""}})),r instanceof HTMLInputElement&&r.type==="radio"){const a=e.querySelectorAll(`input[name="${r.name}"]`);c.options=Array.from(a).map(h=>({value:h.value,text:this.getFieldLabel(h)}));const u=r.closest("div"),g=u==null?void 0:u.querySelector("label:not([for])");g&&(c.label=((d=g.textContent)==null?void 0:d.trim())||c.label)}o.push(c)}),console.log("[DEBUG] Campos extraídos:",o.length),{form_id:"dilatacionForm",fields:o}}getFieldLabel(e){var r,s,c,d;if(e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement){const a=((r=e.labels)==null?void 0:r[0])||document.querySelector(`label[for="${e.id}"]`);if(a)return((s=a.textContent)==null?void 0:s.trim().replace("*","").trim())||""}const o=e.closest("label");if(o)return((c=o.textContent)==null?void 0:c.trim().replace("*","").trim())||"";const t=e.closest("div"),n=t==null?void 0:t.querySelector("label");return n?((d=n.textContent)==null?void 0:d.trim().replace("*","").trim())||"":e.name||e.id||"Sin etiqueta"}sendAudioChunk(e){console.log("[WS] Preparando envío de chunk - size:",e.size);const o=new FileReader;o.onloadend=()=>{const n=o.result.split(",")[1];console.log("[WS] Base64 generado:",n.length,"caracteres"),this.ws&&this.isConnected?(this.ws.send(JSON.stringify({type:"audio_chunk",data:n})),console.log("[WS] Chunk enviado correctamente")):console.error("[WS] WebSocket NO conectado")},o.onerror=t=>{console.error("[WS] Error leyendo blob:",t)},o.readAsDataURL(e)}handleMessage(e){switch(console.log("Mensaje recibido del servidor:",e),e.type){case"transcription":this.updateTranscription(e.text);break;case"field_mapped":this.highlightField(e.field_name);break;case"validation_result":this.handleValidation(e);break;case"autofill_data":this.autofillForm(e.data);break;case"tts_audio":this.playTTSAudio(e.audio_base64);break;case"error":console.error("Error del servidor:",e.message),this.showError(e.message);break;case"info":console.log("Info del servidor:",e.message);break}}updateTranscription(e){const o=document.getElementById("transcriptionPanel"),t=document.getElementById("transcriptionText");o&&t&&(o.classList.remove("hidden"),t.textContent=e,console.log("Transcripción actualizada:",e))}highlightField(e){const o=document.querySelector(`[name="${e}"]`);o&&(o.classList.add("field-highlight"),setTimeout(()=>{o.classList.remove("field-highlight")},2e3))}handleValidation(e){if(e.is_valid)this.showSuccess("Formulario completado correctamente");else{const o=e.missing_fields.join(", ");this.showWarning(`Campos faltantes: ${o}`)}}autofillForm(e){console.log("Auto-llenando formulario:",e),Object.entries(e).forEach(([o,t])=>{console.log(`Buscando campo: ${o} = ${t}`);const n=document.querySelector(`[name="${o}"]`);if(!n){console.warn(`Campo no encontrado: ${o}`);return}console.log(`Campo encontrado: ${o} (${n.type||n.tagName})`);try{if(n instanceof HTMLInputElement&&n.type==="radio"){const r=document.querySelector(`[name="${o}"][value="${t}"]`);r?(r.checked=!0,r.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`Radio marcado: ${o} = ${t}`)):console.warn(`Radio value no encontrado: ${t}`)}else if(n instanceof HTMLInputElement&&n.type==="checkbox")n.checked=!!t,n.dispatchEvent(new Event("change",{bubbles:!0}));else if(n instanceof HTMLSelectElement){const r=String(t).toLowerCase();let s=Array.from(n.options).find(c=>c.value.toLowerCase()===r);s||(s=Array.from(n.options).find(c=>{var d;return(d=c.textContent)==null?void 0:d.toLowerCase().includes(r)})),s?(n.value=s.value,n.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`Select cambiado: ${o} = ${s.value}`)):console.warn(`Opción no encontrada en select para: ${t}`)}else n.value=String(t),n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`Campo actualizado: ${o} = ${t}`);n.classList.add("field-highlight"),setTimeout(()=>{n.classList.remove("field-highlight")},2e3)}catch(r){console.error(`Error llenando campo ${o}:`,r)}}),this.showSuccess("Formulario actualizado automáticamente"),console.log("Auto-fill completado")}async playTTSAudio(e){try{await new Audio(`data:audio/mpeg;base64,${e}`).play(),console.log("Audio TTS reproducido")}catch(o){console.error("Error reproduciendo audio TTS:",o)}}updateConnectionStatus(e){const o=document.getElementById("connectionStatus");if(o){const t=o.querySelector("div"),n=o.querySelector("span");e?(t==null||t.classList.remove("bg-red-400"),t==null||t.classList.add("bg-green-400"),n&&(n.textContent="Sistema Activo")):(t==null||t.classList.remove("bg-green-400"),t==null||t.classList.add("bg-red-400"),n&&(n.textContent="Desconectado"))}}showSuccess(e){this.showNotification(e,"success")}showWarning(e){this.showNotification(e,"warning")}showError(e){this.showNotification(e,"error")}showNotification(e,o){const t={success:"bg-green-100 border-green-500 text-green-900",warning:"bg-yellow-100 border-yellow-500 text-yellow-900",error:"bg-red-100 border-red-500 text-red-900"},n=document.createElement("div");n.className=`fixed top-4 right-4 p-4 rounded-lg border-l-4 ${t[o]} shadow-lg z-50 animate-slideIn`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.remove()},5e3)}disconnect(){var e;(e=this.ws)==null||e.close()}}class S{constructor(){l(this,"voiceWS");this.voiceWS=new v,console.log("FormController instanciado")}init(){console.log("Inicializando FormController..."),this.setupVoiceButtons(),this.setupDilationToggle(),this.setupWordCounter(),this.setupFieldCounter(),this.setupFormSubmit(),console.log("Event listeners configurados")}setupVoiceButtons(){const e=document.getElementById("startVoiceBtn"),o=document.getElementById("stopVoiceBtn");if(!e||!o){console.error("No se encontraron los botones de voz");return}console.log("Botones de voz encontrados"),e.addEventListener("click",async()=>{console.log('Click en "Iniciar Dictado"');try{await this.voiceWS.startVoiceInput()?(console.log("Captura de voz iniciada"),e.classList.add("hidden"),o.classList.remove("hidden")):console.error("No se pudo iniciar la captura")}catch(t){console.error("Error al iniciar dictado:",t),alert(`Error al iniciar el dictado: ${t.message}`)}}),o.addEventListener("click",()=>{console.log('Click en "Detener"');try{this.voiceWS.stopVoiceInput(),o.classList.add("hidden"),e.classList.remove("hidden"),console.log("Grabación detenida")}catch(t){console.error("Error al detener:",t)}})}setupDilationToggle(){document.querySelectorAll('input[name="requiere_dilatacion"]').forEach(o=>{o.addEventListener("change",t=>{const n=t.target,r=document.getElementById("registroSection"),s=document.getElementById("motivoNoDialatacionSection"),c=document.getElementById("motivo_no_dilatacion");!r||!s||!c||(n.value==="si"?(r.classList.remove("hidden"),s.classList.add("hidden"),c.required=!1,c.value="",console.log("Sección de registro mostrada")):(r.classList.add("hidden"),s.classList.remove("hidden"),c.required=!0,console.log("Sección de motivo mostrada")))})})}setupWordCounter(){const e=document.getElementById("transcriptionText");if(!e)return;new MutationObserver(()=>{var s;const t=((s=e.textContent)==null?void 0:s.trim())||"",n=t?t.split(/\s+/).length:0,r=document.getElementById("wordCount");r&&(r.textContent=String(n))}).observe(e,{characterData:!0,childList:!0,subtree:!0})}setupFieldCounter(){const e=document.getElementById("dilatacionForm");e&&e.addEventListener("input",()=>{const o=e.querySelectorAll("input[required], select[required], textarea[required]"),t=Array.from(o).filter(r=>r instanceof HTMLInputElement&&r.type==="radio"?e.querySelector(`input[name="${r.name}"]:checked`)!==null:r.value.trim()!=="").length,n=document.getElementById("fieldsFilled");n&&(n.textContent=`${t}/${o.length}`)})}setupFormSubmit(){const e=document.getElementById("dilatacionForm");e&&e.addEventListener("submit",o=>{o.preventDefault(),console.log("Formulario enviado");const t=new FormData(e),n=Object.fromEntries(t);console.log("Datos del formulario:",n),alert(`¡Registro guardado exitosamente!

Revisa la consola para ver los datos.`)})}getVoiceWS(){return this.voiceWS}}document.addEventListener("DOMContentLoaded",()=>{console.log("=".repeat(50)),console.log("Medical Voice Form - TypeScript"),console.log("=".repeat(50));const i=new S;i.init(),window.app=i,console.log("Aplicación inicializada correctamente")});window.testMicrophone=E;window.checkDevices=b;console.log("Funciones de test disponibles:");console.log("  - testMicrophone() → Prueba el micrófono por 5 segundos");console.log("  - checkDevices()   → Lista todos los dispositivos de audio");
